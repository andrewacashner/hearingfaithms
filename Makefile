# Andrew Cashner's book on villancicos for Brill
# Makefile, 2020/02/10
#
# Compile music examples to PDF with Lilypond
# Compile main LaTeX document, including those PDFs

# INPUT
# Main file
main_in		= main.tex

# TeX input subfiles
chapters_in	= $(wildcard chapters/*.tex)
poem_exx_in	= $(wildcard poem-examples/*.tex)
diagrams_in	= $(wildcard diagrams/*.tex)
tables_in	= $(wildcard tables/*.tex)
tex_subfiles	= $(chapters_in) $(poem_exx_in) $(diagrams_in) $(tables_in)

# Lilypond input files
ly_in_dir	= music-examples
ly_in 		= $(wildcard $(ly_in_dir)/*.ly)

# Figure source files
figures_in	= $(wildcard figures/*.jpg) # TODO preferred file format?

# Library files
ly_lib		= $(wildcard ly/*.ly)
tex_lib		= $(wildcard tex/*.cls) $(wildcard tex/*.sty)
bib		= tex/master.bib


# OUTPUT
# Destination directories
aux 		= aux
aux_chapters	= $(aux)/chapters
build 		= build
music_out_dir	= $(build)/music-examples
figures_dir	= $(build)/figures
dirs		= $(aux) $(aux_chapters) $(build) \
		  $(music_out_dir) $(figures_dir)

# Main output
main_out	= $(build)/Cashner-2020-Hearing_Faith.pdf

# Music example PDFs generated by Lilypond
music_exx_pdfs	= $(addprefix $(build)/,$(ly_in:%.ly=%.pdf))

# Figures in build dir
figures_out	= $(addprefix $(build)/,$(figures_in))

# Temporary files
main_aux	= $(addprefix $(aux)/,$(main_in:%.tex=%.pdf))


# TARGETS and RULES
.PHONY : all ly clean reset 

all : $(main_out)

ly : $(music_exx_pdfs)

# Compile main tex file to aux dir
$(main_aux) : $(main_in) $(tex_subfiles) $(tex_lib) $(bib) \
    $(music_exx_pdfs) $(figures_out) | $(dirs)
	latexmk -outdir=aux -pdfxe $<

# Copy and rename result to build dir
$(main_out) : $(main_aux)
	cp -u $< $@

# Compile Lilypond PDFs to music_exx dir
$(music_exx_pdfs) : $(ly_in) $(ly_lib) | $(dirs)

$(music_out_dir)/%.pdf : %.pdf
	cp -u $< $@

%.pdf : $(ly_in_dir)/%.ly 
	lilypond -I ly $<

# Just copy the figures
$(figures_out) : $(figures_in)
	cp -u $< $@

# Make needed directories first
$(dirs) :
	mkdir -p $(dirs)


# Clean up: clean removes aux, reset removes aux and build
clean : 
	rm -rf $(aux)

reset : clean
	rm -rf $(build)


