# Makefile for monograph on villancicos
# Andrew A. Cashner

# 2019/05/29	Streamlined for LaTeX->PDF with all standalone floats
# 2018/07/30 	Working version to create both PDF and ODT, with float files
# 		separately compiled as PDFs
# 2018/06/02	Begun

# (1-a) Compile LaTeX document controlled by master file main.tex to PDF.
# Compilation with XeLaTeX includes chapter files, bibliography automatically.
# Style determined by vcbook.cls, which in turn calls memoir class or (with
# `ms' option), vcbook-manuscript.cls; and vcbook-macros.sty.
# Either way, the master document will include the floats (PDFs generated by
# LaTeX or Lilypond or JPG/PNG image files) as graphics using adjustbox so that
# they will always be scaled to fit in the textblock.
#
# (1-b) Track and compile included floats (LaTeX or Lilypond) separately from
# main LaTeX file; put main output in build/main.pdf and included float PDFs in
# subdirs under build/.
# Style determined by vcbook-float.cls (for LaTeX, with class options to
# indicate poem, table, or dia[gram]) and ~/ly/villancico.ly  and
# ~/ly/example.ly (for Lilypond).

# DIRECTORIES
#   Process in aux; Put results in build 
#   Subdirectories in build match directory of source file
build-pdf-dirs  := $(addprefix build/,diagrams poem-examples music-examples tables)
dirs 		:= aux aux/chapters build $(build-pdf-dirs) build/figures

# FILES
## Main source and subfiles
main		= main.tex
final		= build/Cashner-Hearing_Faith.pdf
chapters 	= $(wildcard chapters/*.tex)

## Sources and targets for included float files
dia-src 	= $(wildcard diagrams/*.tex)
figure-src 	= $(wildcard figures/*.jpg)
music-src 	= $(wildcard music-examples/*.ly)
poem-src 	= $(wildcard poem-examples/*.tex)
table-src 	= $(wildcard tables/*.tex)

tex-input	= $(chapters) master.bib
tex-floats	= $(dia-src) $(poem-src) $(table-src) 
ly-floats	= $(music-src) 

## PDF outputs of compiling .tex and .ly files
pdf-output	= $(addprefix build/,$(main:%.tex=%.pdf))
aux-output	= $(addprefix aux/,$(main:%.tex=%.pdf))
ly-float-pdfs 	= $(addprefix build/,$(music-src:%.ly=%.pdf))
tex-float-pdfs	= $(addprefix build/,$(tex-floats:%.tex=%.pdf))
figures 	= $(addprefix build/,$(figure-src))

floats 		= $(ly-float-pdfs) $(tex-float-pdfs) $(figures)

## Configuration files
tex-config	= $(wildcard *.cls *.sty)
ly-dir		= $(HOME)/ly
ly-config	= $(wildcard $(ly-dir)/vcbook-*.ly) 
# TODO replace with local files

# COMMANDS
dolatex		= latexmk -pdfxe -outdir=aux
dosublatex 	= $(dolatex) -silent
dolilypond 	= lilypond -O TeX-GS -I $(ly-dir) --silent
quiet   	= &>/dev/null &

#************************************************************************
# RULES
.PHONY : all draft view view-draft count clean reset

# Default target 
## Full document LaTeX->PDF
all : $(final)

draft: $(pdf-output)

### Create needed directories
$(dirs) :
	mkdir -p $(dirs)

### Clean up PDF fonts by postprocessing with Ghostscript
$(final) : $(aux-output)
	gs -o $@ -sDEVICE=pdfwrite -dPDFSETTINGS=/prepress $<

$(pdf-output) : $(aux-output)
	cp $< $@

### Build dirs and floats first; use pattern rule above for LaTeX compilation
$(aux-output) : $(main) $(tex-config) $(tex-input) | $(dirs) $(floats)
	$(dolatex) $<


#************************************************************************
## Floats for inclusion as separate PDFs in subdirectories
aux/%.pdf : diagrams/%.tex | $(ly-float-pdfs)
	$(dosublatex) $<

aux/%.pdf : poem-examples/%.tex 
	$(dosublatex) $<

aux/%.pdf : tables/%.tex 
	$(dosublatex) $<

aux/%.pdf : music-examples/%.ly 
	$(dolilypond) -o aux/$* $<

### Crop and move float PDFs to build subdirectories
$(foreach dir,$(build-pdf-dirs),$(dir)/%.pdf) : aux/%.pdf
	pdfcrop $< $@
	rm $<

## Just copy figures
build/figures/%.jpg : figures/%.jpg
	cp -n $< $@

#************************************************************************
# VIEW
view : all
	xpdf $(final) &

view-draft : draft
	xpdf $(pdf-output) &

# COUNT
count : all
	pdftotext $(final) - | wc -w

#************************************************************************
# CLEANUP
clean : 
	-rm -rf aux

reset : clean
	-rm -rf build

